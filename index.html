<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Для тебя</title>
<style>
:root{
  --bg1:#2a0014;      /* темный бордовый */
  --bg2:#4a0022;      /* бордово-розовый */
  --card:rgba(255,255,255,.10);
  --text:#ffe6f2;
  --muted:#ffb6d5;
  --accent:#ff2e63;   /* красно-розовый */
  --accent2:#ff6b9e;  /* розовый */
  --ok:#37d67a;
  --bad:#ff5c7a;
}

body{
  margin:0;
  font-family:system-ui;
  color:var(--text);
  overflow-x:hidden;

  /* Фон: градиенты + повторяющийся паттерн 21+ */
  background-image:
    /* мягкие световые пятна */
    radial-gradient(900px 600px at 20% 0%, rgba(255,46,99,.22) 0%, transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(255,107,158,.18) 0%, transparent 60%),

    /* паттерн 21+ (мелко, повтор по всей площади) */
    repeating-linear-gradient(0deg, transparent 0 84px, rgba(255,255,255,.04) 84px 85px),
    repeating-linear-gradient(90deg, transparent 0 84px, rgba(255,255,255,.04) 84px 85px),

    /* базовый градиент */
    linear-gradient(160deg, var(--bg1), var(--bg2));
}

/* Текстовый паттерн 21+ поверх градиентов (часто, мелко) */
body{
  margin:0;
  font-family:system-ui;
  color:var(--text);
  overflow-x:hidden;

  background:
    /* паттерн 21+ (SVG, повторяется по всей площади) */
    url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='520' height='520'>\
<rect width='100%25' height='100%25' fill='transparent'/>\
<g fill='rgba(255,255,255,0.07)' font-family='system-ui' font-weight='900'>\
  <text x='20'  y='90'  font-size='64' transform='rotate(-12 20 90)'>21+</text>\
  <text x='240' y='70'  font-size='46' transform='rotate(9 240 70)'>21+</text>\
  <text x='120' y='210' font-size='72' transform='rotate(-6 120 210)'>21+</text>\
  <text x='360' y='190' font-size='58' transform='rotate(14 360 190)'>21+</text>\
  <text x='40'  y='340' font-size='54' transform='rotate(7 40 340)'>21+</text>\
  <text x='260' y='320' font-size='80' transform='rotate(-10 260 320)'>21+</text>\
  <text x='150' y='470' font-size='60' transform='rotate(11 150 470)'>21+</text>\
  <text x='380' y='470' font-size='44' transform='rotate(-8 380 470)'>21+</text>\
</g>\
</svg>") repeat,

    /* световые пятна */
    radial-gradient(900px 600px at 20% 0%, rgba(255,46,99,.22) 0%, transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(255,107,158,.18) 0%, transparent 60%),

    /* базовый градиент */
    linear-gradient(160deg, var(--bg1), var(--bg2));

  background-size: 520px 520px, auto, auto, auto;
}

/* Контент поверх фона */
.wrap{
  position:relative;
  z-index:1;
  max-width:900px;
  margin:0 auto;
  padding:20px;
}

.card{
  background:var(--card);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  padding:16px;
  margin:12px 0;
  box-shadow:0 18px 55px rgba(0,0,0,.55), 0 0 40px rgba(255,46,99,.16);
}

.row{display:flex;gap:10px;flex-wrap:wrap}
.row>*{flex:1}

input,button{
  font:inherit;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.16);
  padding:12px 14px;
  background:rgba(255,255,255,.08);
  color:var(--text);
}

input:focus{
  outline:none;
  border-color:rgba(255,107,158,.8);
  box-shadow:0 0 18px rgba(255,107,158,.35);
}

button{
  cursor:pointer;
  border:none;
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  font-weight:700;
}

.status{font-weight:700;margin-top:10px}
.ok{color:var(--ok)}
.bad{color:var(--bad)}

/* Адаптивный видеоплеер 16:9 */
#player{
  position:relative;
  width:100%;
  aspect-ratio:16/9;
  border-radius:14px;
  overflow:hidden;
  background:#000;
}

/* iframe от YouTube занимает весь контейнер */
#player iframe{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
}

#qBlock{display:none;margin-top:14px}
#confetti{position:fixed;inset:0;pointer-events:none;display:none}
.small{color:var(--muted);font-size:13px}

@media (max-width:520px){
  .wrap{padding:14px;}
  .card{padding:14px;}
  body::before{font-size:18px;letter-spacing:14px;line-height:62px;}
}
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="card">
    <div id="player"></div>

    <div id="qBlock">
      <p id="question"></p>
      <div class="row">
        <input id="answer" placeholder="Ответ"/>
        <button id="checkBtn">Проверить</button>
      </div>
      <button id="hintBtn" style="margin-top:10px;display:none">Подсказка</button>
      <p id="hint" class="small" style="display:none"></p>
      <div id="status" class="status"></div>
    </div>
  </div>
</div>

<script type="module">
import { norm } from "./app.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// TODO: вставь firebaseConfig
const firebaseConfig = {
  apiKey: "AIzaSyDlXwYw8SmqQbZuHmLiJa3oLcyeXHRrY",
  authDomain: "gift-quest-fb6ec.firebaseapp.com",
  projectId: "gift-quest-fb6ec",
  storageBucket: "gift-quest-fb6ec.firebasestorage.app",
  messagingSenderId: "469689235633",
  appId: "1:469689235633:web:395f43a16e1c2124cd0a90",
  measurementId: "G-Y3R3ZZZL1J"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const cfgRef = doc(db,"public","config");

let cfg;
let stepIndex = 0;
let player;
let attempts = 0;

function extractYouTubeID(url){
  const m1 = url.match(/youtu\.be\/([a-zA-Z0-9_-]+)/);
  const m2 = url.match(/[?&]v=([a-zA-Z0-9_-]+)/);
  return m1 ? m1[1] : m2 ? m2[1] : null;
}

function loadYouTubeAPI(){
  return new Promise(resolve=>{
    if(window.YT) return resolve();
    const tag=document.createElement('script');
    tag.src="https://www.youtube.com/iframe_api";
    window.onYouTubeIframeAPIReady=()=>resolve();
    document.body.appendChild(tag);
  });
}

function destroyPlayer(){
  try{ if(player && player.destroy) player.destroy(); }catch(e){}
  player = null;
  document.getElementById("player").innerHTML = "";
}

function playVideo(url){
  destroyPlayer();
  document.getElementById("qBlock").style.display="none";
  document.getElementById("status").textContent="";
  document.getElementById("answer").value="";
  document.getElementById("hint").style.display="none";
  attempts=0;

  const id = extractYouTubeID(url);
  if(!id){
    document.getElementById("status").textContent="Ошибка: не могу извлечь YouTube ID из ссылки.";
    document.getElementById("status").className="status bad";
    return;
  }

  player = new YT.Player('player',{
    videoId:id,
   playerVars:{
  autoplay:1,
  rel:0,
  playsinline:1,
  modestbranding:1,
  mute:1
},
   events:{
  onReady:function(e){
    e.target.mute();       // обязательно для iOS
    e.target.playVideo();  // принудительный запуск
  },
  onStateChange:function(e){
    if(e.data === YT.PlayerState.ENDED){
      showQuestion();
    }
  }
}
  });
}

function showQuestion(){
  const s = cfg.steps[stepIndex];
  document.getElementById("question").textContent = s.question;
  document.getElementById("qBlock").style.display="block";
  if(s.hint){
    document.getElementById("hintBtn").style.display="inline-block";
  } else {
    document.getElementById("hintBtn").style.display="none";
  }
  document.getElementById("answer").focus();
}

function nextStep(){
  stepIndex++;
  if(stepIndex < cfg.steps.length){
    playVideo(cfg.steps[stepIndex].videoUrl);
  } else {
    runConfetti();
    if(cfg.finale?.videoUrl){
      setTimeout(()=>playVideo(cfg.finale.videoUrl), 1200);
    }
  }
}

document.getElementById("hintBtn").onclick=()=>{
  const s = cfg.steps[stepIndex];
  const h = document.getElementById("hint");
  h.textContent = s.hint || "";
  h.style.display = (h.style.display==="none") ? "block" : "none";
};

document.getElementById("checkBtn").onclick=()=>{
  const s = cfg.steps[stepIndex];
  const val = norm(document.getElementById("answer").value);
  if(val === norm(s.answer)){
    document.getElementById("status").textContent="Верно";
    document.getElementById("status").className="status ok";
    nextStep();
  } else {
    attempts++;
    document.getElementById("status").textContent="Пока нет";
    document.getElementById("status").className="status bad";
    if(attempts>=2 && s.hint){
      document.getElementById("hint").textContent=s.hint;
      document.getElementById("hint").style.display="block";
    }
  }
};

function runConfetti(){
  const c=document.getElementById("confetti");
  const ctx=c.getContext("2d");
  c.width=window.innerWidth;
  c.height=window.innerHeight;
  c.style.display="block";

  const parts=Array.from({length:200}).map(()=>({
    x:Math.random()*c.width,
    y:-20,
    r:2+Math.random()*4,
    vy:2+Math.random()*4,
    vx:-1+Math.random()*2
  }));

  let t=0;
  function frame(){
    t++;
    ctx.clearRect(0,0,c.width,c.height);
    parts.forEach(p=>{
      p.x+=p.vx;
      p.y+=p.vy;
      ctx.fillRect(p.x,p.y,p.r,p.r);
    });
    if(t<180) requestAnimationFrame(frame);
    else c.style.display="none";
  }
  frame();
}

(async()=>{
  const snap = await getDoc(cfgRef);
  if(!snap.exists()){
    document.getElementById("status").textContent="Конфиг не найден. Сначала сохрани его в admin.html";
    document.getElementById("status").className="status bad";
    return;
  }
  cfg = snap.data();

  if(!cfg.steps || !cfg.steps.length){
    document.getElementById("status").textContent="В конфиге нет шагов.";
    document.getElementById("status").className="status bad";
    return;
  }

  await loadYouTubeAPI();
  playVideo(cfg.steps[0].videoUrl);
})();
</script>
</body>
</html>
