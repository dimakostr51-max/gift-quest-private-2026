<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Для тебя</title>

<style>
:root{
  --bg1:#2a0014;
  --bg2:#4a0022;
  --card:rgba(255,255,255,.10);
  --text:#ffe6f2;
  --muted:#ffb6d5;
  --accent:#ff2e63;
  --accent2:#ff6b9e;
  --ok:#37d67a;
  --bad:#ff5c7a;
}

body{
  margin:0;
  font-family:system-ui;
  color:var(--text);
  overflow-x:hidden;

  background:
    url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='520' height='520'>\
<rect width='100%25' height='100%25' fill='transparent'/>\
<g fill='rgba(255,255,255,0.07)' font-family='system-ui' font-weight='900'>\
  <text x='20'  y='90'  font-size='64' transform='rotate(-12 20 90)'>21+</text>\
  <text x='240' y='70'  font-size='46' transform='rotate(9 240 70)'>21+</text>\
  <text x='120' y='210' font-size='72' transform='rotate(-6 120 210)'>21+</text>\
  <text x='360' y='190' font-size='58' transform='rotate(14 360 190)'>21+</text>\
  <text x='40'  y='340' font-size='54' transform='rotate(7 40 340)'>21+</text>\
  <text x='260' y='320' font-size='80' transform='rotate(-10 260 320)'>21+</text>\
  <text x='150' y='470' font-size='60' transform='rotate(11 150 470)'>21+</text>\
  <text x='380' y='470' font-size='44' transform='rotate(-8 380 470)'>21+</text>\
</g>\
</svg>") repeat,

    radial-gradient(900px 600px at 20% 0%, rgba(255,46,99,.22) 0%, transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(255,107,158,.18) 0%, transparent 60%),
    linear-gradient(160deg, var(--bg1), var(--bg2));

  background-size: 520px 520px, auto, auto, auto;
  background-position: 0 0, 0 0, 0 0, 0 0;
  animation: bgDrift 22s linear infinite;
}
@keyframes bgDrift{
  from { background-position: 0 0, 0 0, 0 0, 0 0; }
  to   { background-position: 260px 180px, 0 0, 0 0, 0 0; }
}

.wrap{
  position:relative;
  z-index:1;
  max-width:900px;
  margin:0 auto;
  padding:20px;
}

.card{
  background:var(--card);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  padding:16px;
  margin:12px 0;
  box-shadow:0 18px 55px rgba(0,0,0,.55), 0 0 40px rgba(255,46,99,.16);
  position:relative;
  overflow:hidden;
  transform: translateY(0);
  transition: transform .35s ease, box-shadow .35s ease;
}
.card:hover{
  transform: translateY(-2px);
  box-shadow: 0 22px 60px rgba(0,0,0,.45);
}

.row{display:flex;gap:10px;flex-wrap:wrap}
.row>*{flex:1}

input,button{
  font:inherit;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.16);
  padding:12px 14px;
  background:rgba(255,255,255,.08);
  color:var(--text);
}
input:focus{
  outline:none;
  border-color:rgba(255,107,158,.8);
  box-shadow: 0 0 0 3px rgba(255,92,122,.22);
}

button{
  cursor:pointer;
  border:none;
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  font-weight:700;
  transition: transform .08s ease, filter .2s ease, box-shadow .2s ease;
  will-change: transform;
}
button:hover{ filter: brightness(1.08); }
button:active{ transform: translateY(1px) scale(.99); }

.status{font-weight:700;margin-top:10px}
.ok{color:var(--ok)}
.bad{color:var(--bad)}
.small{color:var(--muted);font-size:13px}

/* Плеер */
#player{
  position:relative;
  width:100%;
  aspect-ratio:16/9;
  border-radius:14px;
  overflow:hidden;
  background:#000;
  transform: translateY(6px);
  transition: transform .6s ease;
}
#player.ready{ transform: translateY(0); }

#player iframe{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  border:0;
}

/* Лоадер поверх плеера */
#loader{
  position:absolute;
  inset: 16px 16px auto 16px;
  height: calc(56.25% + 0px);
  border-radius: 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  background: rgba(0,0,0,.35);
  backdrop-filter: blur(6px);
  pointer-events:none;
  opacity:1;
  transition: opacity .4s ease;
}
#loader.hide{ opacity:0; }
.spinner{
  width:18px;height:18px;border-radius:50%;
  border:2px solid rgba(255,255,255,.25);
  border-top-color: rgba(255,255,255,.85);
  animation: spin .8s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }

/* Overlay “Нажми для старта” (нужен для Safari/мобилок) */
#tapToStart{
  position:absolute;
  inset: 16px 16px auto 16px;
  height: calc(56.25% + 0px);
  border-radius: 14px;
  display:none;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:18px;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(10px);
}
#tapToStart.show{ display:flex; }
#tapToStart .box{
  max-width:520px;
}
#tapToStart .title{
  font-weight:800;
  font-size:18px;
  margin-bottom:8px;
}
#tapToStart .desc{
  opacity:.85;
  margin-bottom:14px;
  font-size:14px;
}
#tapToStart .btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:220px;
}

/* Вопрос */
#qBlock{display:none;margin-top:14px}
#qBlock.show{ animation: rise .45s ease both; }
@keyframes rise{
  from{ opacity:0; transform: translateY(10px); }
  to{ opacity:1; transform: translateY(0); }
}

/* Конфетти */
#confetti{
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  display: none;
  z-index: 999999; /* ВАЖНО: поверх всего, включая плеер */
}
/* Дисклеймер-модалка */
#disclaimerModal{
  position:fixed;
  inset:0;
  z-index:9999;
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(10px);
}
#disclaimerModal.show{ display:flex; }
#disclaimerCard{
  width:min(720px, 100%);
  background: rgba(18,26,41,.92);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  box-shadow:0 30px 80px rgba(0,0,0,.55);
  padding:18px;
}
#disclaimerTitle{
  font-size:18px;
  font-weight:900;
  margin:0 0 10px 0;
}
#disclaimerText{
  margin:0;
  white-space:pre-wrap;
  line-height:1.35;
  opacity:.95;
}
#disclaimerBtns{
  display:flex;
  gap:10px;
  margin-top:14px;
}
#disclaimerBtns button{
  flex:1;
}
#noBtn{
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.16);
}
#noBtn:hover{ filter: brightness(1.06); }

@media (max-width:520px){
  .wrap{padding:14px;}
  .card{padding:14px;}
  #disclaimerBtns{ flex-direction:column; }
}
</style>
</head>

<body>

<!-- Дисклеймер -->
<div id="disclaimerModal" aria-modal="true" role="dialog">
  <div id="disclaimerCard">
    <div id="disclaimerTitle">Подтверждение</div>
    <p id="disclaimerText"></p>
    <div id="disclaimerBtns">
      <button id="yesBtn">ДА</button>
      <button id="noBtn">НЕТ</button>
    </div>
    <div class="small" style="margin-top:10px;opacity:.85">
      Если звук не начнётся автоматически — это ограничение браузера. Нажми «ДА», и мы запустим всё корректно.
    </div>
  </div>
</div>

<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="card">
    <div id="player"></div>

    <div id="loader">
      <div class="spinner"></div>
      <div class="small">Загружаю видео…</div>
    </div>

    <div id="tapToStart">
      <div class="box">
        <div class="title">Нажми, чтобы стартовать со звуком</div>
        <div class="desc">Некоторые браузеры блокируют автозапуск видео со звуком. Один тап — и всё включится.</div>
        <button id="tapBtn" class="btn">СТАРТ</button>
      </div>
    </div>

    <div id="qBlock">
      <p id="question"></p>
      <div class="row">
        <input id="answer" placeholder="Ответ"/>
        <button id="checkBtn">Проверить</button>
      </div>
      <button id="hintBtn" style="margin-top:10px;display:none">Подсказка</button>
      <p id="hint" class="small" style="display:none"></p>
      <div id="status" class="status"></div>
    </div>

    <div id="boot" class="small" style="margin-top:10px;opacity:.85"></div>
  </div>
</div>

<script type="module">
import { norm } from "./app.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlXwYw8SmqQbZuHmLiJa3oLcyeXHRrY",
  authDomain: "gift-quest-fb6ec.firebaseapp.com",
  projectId: "gift-quest-fb6ec",
  storageBucket: "gift-quest-fb6ec.firebasestorage.app",
  messagingSenderId: "469689235633",
  appId: "1:469689235633:web:395f43a16e1c2124cd0a90",
  measurementId: "G-Y3R3ZZZL1J"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const cfgRef = doc(db,"public","config");

let cfg;
let stepIndex = 0;
let player;
let attempts = 0;

const loader = document.getElementById("loader");
const playerEl = document.getElementById("player");
const boot = document.getElementById("boot");

const modal = document.getElementById("disclaimerModal");
const disclaimerTextEl = document.getElementById("disclaimerText");
const yesBtn = document.getElementById("yesBtn");
const noBtn = document.getElementById("noBtn");

const tapOverlay = document.getElementById("tapToStart");
const tapBtn = document.getElementById("tapBtn");

let started = false;          // чтобы сайт не стартовал до подтверждения
let lastVideoId = null;       // текущий id, чтобы повторно стартовать по тапу

function setBoot(msg, kind=""){
  boot.textContent = msg;
  boot.style.color = kind==="bad" ? "var(--bad)" : kind==="ok" ? "var(--ok)" : "var(--muted)";
}

function extractYouTubeID(url){
  const m1 = url.match(/youtu\.be\/([a-zA-Z0-9_-]+)/);
  const m2 = url.match(/[?&]v=([a-zA-Z0-9_-]+)/);
  const m3 = url.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]+)/);
  return m1 ? m1[1] : m2 ? m2[1] : m3 ? m3[1] : null;
}

function loadYouTubeAPI(){
  return new Promise((resolve, reject)=>{
    if(window.YT && window.YT.Player) return resolve();
    const tag=document.createElement('script');
    tag.src="https://www.youtube.com/iframe_api";
    tag.onerror = ()=>reject(new Error("YouTube API failed to load"));
    window.onYouTubeIframeAPIReady=()=>resolve();
    document.body.appendChild(tag);
  });
}

function destroyPlayer(){
  try{ if(player && player.destroy) player.destroy(); }catch(e){}
  player = null;
  playerEl.innerHTML = "";
  playerEl.classList.remove("ready");
  loader.classList.remove("hide");
  tapOverlay.classList.remove("show");
}

function showTapOverlay(){
  loader.classList.add("hide");
  playerEl.classList.add("ready");
  tapOverlay.classList.add("show");
}

function hideTapOverlay(){
  tapOverlay.classList.remove("show");
}

function playCurrentWithSound(){
  // вызывается только из пользовательского клика (ДА или СТАРТ)
  if(!player) return;
  try{
    player.unMute();
    player.setVolume(100);
    player.playVideo();
  }catch(_){}
  hideTapOverlay();
}

function playVideo(url){
  destroyPlayer();
  document.getElementById("qBlock").style.display="none";
  document.getElementById("status").textContent="";
  document.getElementById("answer").value="";
  document.getElementById("hint").style.display="none";
  attempts=0;

  const id = extractYouTubeID(url);
  lastVideoId = id;

  if(!id){
    document.getElementById("status").textContent="Ошибка: не могу извлечь YouTube ID из ссылки.";
    document.getElementById("status").className="status bad";
    setBoot("Ошибка: неверная ссылка на YouTube.", "bad");
    return;
  }

  setBoot("Загружаю плеер…");

  player = new YT.Player('player',{
    videoId:id,
    playerVars:{
      autoplay:1,
      rel:0,
      playsinline:1,
      modestbranding:1,
      mute:0 // пытаемся со звуком
    },
    events:{
      onReady:function(e){
        // Пытаемся автозапуск со звуком.
        // На мобильных часто будет заблокировано — тогда показываем overlay.
        try{
          e.target.unMute();
          e.target.setVolume(100);
          const res = e.target.playVideo(); // иногда возвращает Promise-like
          loader.classList.add("hide");
          playerEl.classList.add("ready");
          setBoot("Видео запущено.", "ok");

          // Если браузер заблокировал — плеер останется в state=CUED/UNSTARTED -> покажем overlay чуть позже
          setTimeout(()=>{
            try{
              const st = e.target.getPlayerState();
              if(st === -1 || st === 5){ // UNSTARTED или CUED
                showTapOverlay();
                setBoot("Нужен один тап для старта со звуком (ограничение браузера).", "bad");
              }
            }catch(_){}
          }, 700);

        }catch(err){
          // Если вообще что-то упало — покажем overlay, чтобы стартовать кликом
          showTapOverlay();
          setBoot("Нажми «СТАРТ» для запуска.", "bad");
        }
      },
      onStateChange:function(e){
        // 0 = ended
        if(e.data === YT.PlayerState.ENDED){
          showQuestion();
        }
      },
      onError:function(e){
        loader.classList.add("hide");
        playerEl.classList.add("ready");
        setBoot("Ошибка YouTube: " + e.data, "bad");
        // часто помогает клик-старт
        showTapOverlay();
      }
    }
  });
}

function showQuestion(){
  const s = cfg.steps[stepIndex];
  document.getElementById("question").textContent = s.question;
  const qb = document.getElementById("qBlock");
  qb.style.display="block";
  if(s.hint){
    document.getElementById("hintBtn").style.display="inline-block";
  } else {
    document.getElementById("hintBtn").style.display="none";
  }
  qb.classList.remove("show");
  void qb.offsetWidth;
  qb.classList.add("show");
  document.getElementById("answer").focus();
}

function nextStep(){
  stepIndex++;
  if(stepIndex < cfg.steps.length){
    playVideo(cfg.steps[stepIndex].videoUrl);
  } else {
    runConfetti();
    if(cfg.finale?.videoUrl){
      setTimeout(()=>playVideo(cfg.finale.videoUrl), 1200);
    }
  }
}

document.getElementById("hintBtn").onclick=()=>{
  const s = cfg.steps[stepIndex];
  const h = document.getElementById("hint");
  h.textContent = s.hint || "";
  h.style.display = (h.style.display==="none") ? "block" : "none";
};

document.getElementById("checkBtn").onclick=()=>{
  const s = cfg.steps[stepIndex];
  const val = norm(document.getElementById("answer").value);
  if(val === norm(s.answer)){
    document.getElementById("status").textContent="Верно";
    document.getElementById("status").className="status ok";
    nextStep();
  } else {
    attempts++;
    document.getElementById("status").textContent="Пока нет";
    document.getElementById("status").className="status bad";
    // лёгкий shake на ошибке
    const card = document.querySelector(".card");
    card.classList.remove("shake");
    void card.offsetWidth;
    card.classList.add("shake");

    if(attempts>=2 && s.hint){
      document.getElementById("hint").textContent=s.hint;
      document.getElementById("hint").style.display="block";
    }
  }
};

tapBtn.onclick = ()=>{
  // пользовательский клик -> можно включить звук/старт
  playCurrentWithSound();
};

yesBtn.onclick = ()=>{
  modal.classList.remove("show");
  started = true;

  // стартуем первый шаг
  stepIndex = 0;
  playVideo(cfg.steps[0].videoUrl);

  // после клика можно попробовать форсировать звук
  setTimeout(()=>playCurrentWithSound(), 200);
};

noBtn.onclick = ()=>{
  // “выкинуть” с сайта: универсально нельзя гарантировать закрытие вкладки.
  // Делается редирект + попытка закрытия.
  try{ window.open("", "_self"); window.close(); }catch(_){}
  location.href = "https://www.google.com";
};

function runConfetti(){

  const c = document.getElementById("confetti");
  const ctx = c.getContext("2d");

  c.width = window.innerWidth;
  c.height = window.innerHeight;
  c.style.display = "block";

  const colors = [
    "#ff2e63",
    "#ff6b9e",
    "#ffe066",
    "#37d67a",
    "#ffffff"
  ];

  const particles = Array.from({length: 2000}).map(() => ({
    x: Math.random() * c.width,
    y: -20 - Math.random() * 200,
    size: 4 + Math.random() * 8,
    color: colors[Math.floor(Math.random() * colors.length)],
    vx: -3 + Math.random() * 6,
    vy: 2 + Math.random() * 6,
    gravity: 0.08 + Math.random() * 0.05,
    rotation: Math.random() * 360,
    rotationSpeed: -10 + Math.random() * 20,
    shape: Math.random() > 0.5 ? "rect" : "circle"
  }));

  let frame = 0;
  const maxFrames = 2500; // ~7 секунд при 60fps

  function animate(){
    frame++;
    ctx.clearRect(0, 0, c.width, c.height);

    particles.forEach(p => {

      p.vy += p.gravity;
      p.x += p.vx + Math.sin(frame * 0.05) * 0.5;
      p.y += p.vy;
      p.rotation += p.rotationSpeed;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rotation * Math.PI / 180);
      ctx.fillStyle = p.color;

      if(p.shape === "rect"){
        ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size * 0.6);
      } else {
        ctx.beginPath();
        ctx.arc(0, 0, p.size/2, 0, Math.PI * 2);
        ctx.fill();
      }

      ctx.restore();
    });

    // лёгкое затухание в конце
    if(frame > maxFrames - 60){
      c.style.opacity = 1 - (frame - (maxFrames - 60)) / 60;
    }

    if(frame < maxFrames){
      requestAnimationFrame(animate);
    } else {
      c.style.display = "none";
      c.style.opacity = 1;
    }
  }

  animate();
}

(async()=>{
  try{
    setBoot("Загружаю конфиг…");

    const snap = await getDoc(cfgRef);
    if(!snap.exists()){
      setBoot("Конфиг не найден. Сначала сохрани его в admin.html", "bad");
      document.getElementById("status").textContent="Конфиг не найден. Сначала сохрани его в admin.html";
      document.getElementById("status").className="status bad";
      return;
    }
    cfg = snap.data();

    if(!cfg.steps || !cfg.steps.length){
      setBoot("В конфиге нет шагов.", "bad");
      document.getElementById("status").textContent="В конфиге нет шагов.";
      document.getElementById("status").className="status bad";
      return;
    }

    setBoot("Подключаю YouTube API…");
    await loadYouTubeAPI();
    setBoot("Готово. Ожидаю подтверждения…", "ok");

    // Показ дисклеймера (если текст есть)
    const text = (cfg.disclaimerText || "").trim();
    if(text){
      disclaimerTextEl.textContent = text;
      modal.classList.add("show");
    } else {
      // если дисклеймер не задан — запускаем сразу (как раньше)
      started = true;
      playVideo(cfg.steps[0].videoUrl);
    }

  } catch(e){
    setBoot("Ошибка запуска: " + e.message, "bad");
  }
})();
</script>

</body>
</html>
